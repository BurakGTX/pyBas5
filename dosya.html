<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîí %100 G√ºvenli ≈ûifreli Pastebin</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f0f0; }
    textarea, input[type="password"], input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; }
    button { padding: 14px; font-size: 18px; width: 100%; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #0055aa; }
    #output, #passwordPrompt { margin-top: 20px; background: white; padding: 25px; border: 1px solid #ccc; border-radius: 12px; text-align: center; }
    pre { background:#f8f8f8; padding:20px; border-radius:8px; overflow:auto; border:1px solid #ddd; white-space: pre-wrap; margin-top: 20px; }
    .info { color: #555; font-size: 0.9em; background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0; }
    .warning { color: #c00; font-weight: bold; }
    #content { height: 200px; font-family: monospace; }
  </style>
</head>
<body>
  <h1>üîí %100 G√ºvenli ≈ûifreli Pastebin</h1>
  <p>Metnini yaz, ≈üifreli paste olu≈ütur. Sadece ≈üifre bilen okuyabilir!</p>

  <textarea id="content" placeholder="Gizli metnini buraya yaz..."></textarea>

  <input type="password" id="userPassword" placeholder="ƒ∞steƒüe baƒülƒ±: Kendi ≈üifreni gir (bo≈ü bƒ±rakƒ±rsan otomatik g√º√ßl√º ≈üifre)">

  <button onclick="createPaste()">üîê Paste Olu≈ütur</button>

  <div id="output"></div>
  <div id="passwordPrompt" style="display:none;"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAdYx6KnAiSY6mVtkLt_ZK1R0Rq3Uh1tRY",
      authDomain: "pastebin-61d0b.firebaseapp.com",
      projectId: "pastebin-61d0b",
      storageBucket: "pastebin-61d0b.appspot.com",
      messagingSenderId: "984614843816",
      appId: "1:984614843816:web:77260642b9b5903833999d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Web Crypto AES-256-GCM
    async function encryptText(text, password) {
      const enc = new TextEncoder();
      const data = enc.encode(text);

      let key;
      if (!password) {
        // Otomatik g√º√ßl√º anahtar
        key = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt"]);
      } else {
        const pwKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
        key = await crypto.subtle.deriveKey(
          { name: "PBKDF2", salt: enc.encode("salted__"), iterations: 200000, hash: "SHA-256" },
          pwKey,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt"]
        );
      }

      const iv = crypto.getRandomValues(new Uint8Array(12));
      const exportedKey = await crypto.subtle.exportKey("raw", key);

      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, data);

      const result = new Uint8Array(iv.byteLength + encrypted.byteLength + exportedKey.byteLength);
      result.set(new Uint8Array(exportedKey), 0);
      result.set(iv, exportedKey.byteLength);
      result.set(new Uint8Array(encrypted), exportedKey.byteLength + iv.byteLength);

      return btoa(String.fromCharCode(...result));
    }

    async function decryptText(encryptedBase64, password) {
      try {
        const dec = new TextDecoder();
        const data = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));

        const keyData = data.slice(0, 32); // ƒ∞lk 32 byte anahtar
        const iv = data.slice(32, 44); // Sonraki 12 byte IV
        const ciphertext = data.slice(44);

        let key;
        if (!password) {
          key = await crypto.subtle.importKey("raw", keyData, "AES-GCM", true, ["decrypt"]);
        } else {
          const enc = new TextEncoder();
          const pwKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
          key = await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: enc.encode("salted__"), iterations: 200000, hash: "SHA-256" },
            pwKey,
            { name: "AES-GCM", length: 256 },
            false,
            ["decrypt"]
          );
        }

        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
        return dec.decode(decrypted);
      } catch (e) {
        return null;
      }
    }

    function urlSafe(str) {
      return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function urlUnsafe(str) {
      let s = str.replace(/-/g, '+').replace(/_/g, '/');
      while (s.length % 4) s += '=';
      return s;
    }

    async function createPaste() {
      const content = document.getElementById('content').value.trim();
      if (!content) return alert("Metin bo≈ü olamaz!");

      const userPass = document.getElementById('userPassword').value.trim();
      const useManual = userPass !== "";

      const encrypted = await encryptText(content, useManual ? userPass : null);

      const pasteId = Math.random().toString(36).substring(2, 16); // 14+ karakter

      await db.collection("pastes").doc(pasteId).set({
        data: encrypted,
        hasPassword: useManual,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });

      let shareUrl;
      if (useManual) {
        shareUrl = window.location.href.split('?')[0] + "?id=" + pasteId;
      } else {
        const keyRaw = await crypto.subtle.exportKey("raw", await crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt"]));
        const keyBase64 = btoa(String.fromCharCode(...new Uint8Array(keyRaw)));
        shareUrl = window.location.href.split('?')[0] + "?id=" + pasteId + "&k=" + urlSafe(keyBase64);
      }

      document.getElementById('output').innerHTML = `
        <strong>‚úÖ Paste %100 g√ºvenli olu≈üturuldu!</strong><br><br>
        <strong>Payla≈üƒ±labilir Link:</strong><br>
        <input type="text" value="${shareUrl}" readonly style="width:100%; padding:10px; font-size:14px;"><br><br>
        <div class="info">
          ‚Ä¢ ${useManual ? '<strong>≈ûifreli (manuel ≈üifre)</strong> ‚Üí Linke giren ≈üifre girmeli.' : '<strong>Otomatik ≈üifre</strong> ‚Üí Link direkt a√ßar.'}<br>
          ‚Ä¢ Metin sunucuda tamamen ≈üifreli.<br>
          ‚Ä¢ Kimse (sen dahil) deƒüi≈ütiremez, silemez.<br>
          ‚Ä¢ F12 ile bile metin g√∂r√ºlemez.<br>
          <span class="warning">‚Ä¢ Linki payla≈ütƒ±ƒüƒ±n ki≈üi sadece o g√∂rebilir!</span>
        </div>
      `;
    }

    async function loadPaste() {
      const params = new URLSearchParams(window.location.search);
      const pasteId = params.get('id');
      if (!pasteId) return;

      const doc = await db.collection("pastes").doc(pasteId).get();
      if (!doc.exists) {
        document.getElementById('output').innerHTML = "<strong>Paste bulunamadƒ±!</strong>";
        return;
      }

      const data = doc.data();
      const hasPassword = data.hasPassword;

      if (hasPassword) {
        // ≈ûifre iste
        document.getElementById('passwordPrompt').style.display = 'block';
        document.getElementById('passwordPrompt').innerHTML = `
          <h2>üîí Bu paste ≈üifreli</h2>
          <p>≈ûifreyi girerek metni a√ß:</p>
          <input type="password" id="inputPass" placeholder="≈ûifreyi gir..." style="width:100%;">
          <button onclick="tryDecrypt('${data.data}')">A√ß</button>
          <p id="errorMsg" style="color:red; margin-top:10px;"></p>
        `;
        document.getElementById('output').innerHTML = "<strong>≈ûifre girilmesi gerekiyor...</strong>";
      } else {
        // Otomatik anahtar varsa (k=)
        const keyParam = params.get('k');
        if (!keyParam) {
          document.getElementById('output').innerHTML = "<strong>Otomatik anahtar eksik!</strong>";
          return;
        }

        let rawKey;
        try {
          rawKey = Uint8Array.from(atob(urlUnsafe(keyParam)), c => c.charCodeAt(0));
        } catch (e) {
          document.getElementById('output').innerHTML = "<strong>Bozuk anahtar!</strong>";
          return;
        }

        const decrypted = await decryptText(data.data, null); // password null, ama otomatik anahtar zaten encrypt i√ßinde

        // Hata olursa null d√∂ner
        if (!decrypted) {
          document.getElementById('output').innerHTML = "<strong>Ge√ßersiz otomatik anahtar!</strong>";
          return;
        }

        showDecrypted(decrypted, data.created);
      }
    }

    async function tryDecrypt(encryptedData) {
      const pass = document.getElementById('inputPass').value;
      const decrypted = await decryptText(encryptedData, pass);

      if (decrypted) {
        showDecrypted(decrypted, null);
      } else {
        document.getElementById('errorMsg').textContent = "Yanlƒ±≈ü ≈üifre!";
      }
    }

    function showDecrypted(text, createdTime) {
      const time = createdTime ? createdTime.toDate().toLocaleString('tr-TR') : "Bilinmiyor";
      document.getElementById('passwordPrompt').style.display = 'none';
      document.getElementById('output').innerHTML = `
        <strong>üîì Metin ba≈üarƒ±yla a√ßƒ±ldƒ±!</strong><br>
        Olu≈üturulma: ${time}<br><br>
        <pre>${text}</pre>
      `;
    }

    window.onload = loadPaste;
  </script>
</body>
</html>
