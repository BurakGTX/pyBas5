<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”’ Ultra GÃ¼venli Pastebin (Web Crypto)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f0f0; }
    textarea { width: 100%; height: 200px; font-family: monospace; font-size: 16px; }
    input, button { padding: 12px; margin: 10px 0; font-size: 16px; width: 100%; box-sizing: border-box; }
    #output { margin-top: 20px; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    .info { color: #555; font-size: 0.9em; background: #f9f9f9; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .warning { color: #d00; font-weight: bold; }
    pre { background:#f8f8f8; padding:20px; border-radius:8px; overflow:auto; border:1px solid #ddd; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ğŸ”’ Ultra GÃ¼venli Åifreli Pastebin</h1>
  <p>Metnini yaz, ÅŸifreli paste oluÅŸtur. Sadece doÄŸru ÅŸifreyle aÃ§Ä±lÄ±r!</p>

  <textarea id="content" placeholder="Gizli metnini buraya yaz..."></textarea>

  <input type="password" id="userPassword" placeholder="Ä°steÄŸe baÄŸlÄ±: Kendi ÅŸifreni gir (boÅŸ bÄ±rakÄ±rsan otomatik gÃ¼Ã§lÃ¼ Ã¼retilir)">

  <button onclick="createPaste()">ğŸ” Paste OluÅŸtur (Åifrele)</button>

  <div id="output"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAdYx6KnAiSY6mVtkLt_ZK1R0Rq3Uh1tRY",
      authDomain: "pastebin-61d0b.firebaseapp.com",
      projectId: "pastebin-61d0b",
      storageBucket: "pastebin-61d0b.appspot.com",
      messagingSenderId: "984614843816",
      appId: "1:984614843816:web:77260642b9b5903833999d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Web Crypto ile ÅŸifreleme (AES-256-GCM)
    async function encryptText(text, password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);

      let keyMaterial;
      if (password === "") {
        // Otomatik gÃ¼Ã§lÃ¼ ÅŸifre
        keyMaterial = crypto.getRandomValues(new Uint8Array(32));
      } else {
        keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode(password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );
        keyMaterial = await crypto.subtle.deriveKey(
          { name: "PBKDF2", salt: encoder.encode("saltysalt"), iterations: 100000, hash: "SHA-256" },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt"]
        );
        keyMaterial = await crypto.subtle.exportKey("raw", keyMaterial);
      }

      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cryptoKey = await crypto.subtle.importKey("raw", keyMaterial, "AES-GCM", true, ["encrypt"]);

      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, data);

      const result = new Uint8Array(iv.byteLength + encrypted.byteLength);
      result.set(iv, 0);
      result.set(new Uint8Array(encrypted), iv.byteLength);

      return btoa(String.fromCharCode(...result));
    }

    async function decryptText(encryptedBase64, password) {
      try {
        const decoder = new TextDecoder();
        const data = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));

        const iv = data.slice(0, 12);
        const ciphertext = data.slice(12);

        let cryptoKey;
        if (password === "") {
          return null; // Otomatik ÅŸifreyle manuel Ã§Ã¶zÃ¼lemez
        } else {
          const encoder = new TextEncoder();
          const keyMaterial = await crypto.subtle.importKey(
            "raw",
            encoder.encode(password),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
          );
          cryptoKey = await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: encoder.encode("saltysalt"), iterations: 100000, hash: "SHA-256" },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["decrypt"]
          );
        }

        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, ciphertext);
        return decoder.decode(decrypted);
      } catch (e) {
        return null;
      }
    }

    // Base64 gÃ¼venli URL encode (k= parametresi iÃ§in)
    function urlSafeBase64(str) {
      return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function createPaste() {
      const content = document.getElementById('content').value.trim();
      if (!content) return alert("Metin boÅŸ olamaz!");

      const userPass = document.getElementById('userPassword').value.trim();

      // Åifreyi Ã¼ret (manuel veya otomatik)
      const password = userPass || crypto.getRandomValues(new Uint8Array(32)).reduce((a,b)=>a+b.toString(16).padStart(2,'0'),''); // 64 char hex

      const encrypted = await encryptText(content, userPass);

      const pasteId = Math.random().toString(36).substring(2, 14);

      await db.collection("pastes").doc(pasteId).set({
        data: encrypted,
        created: firebase.firestore.FieldValue.serverTimestamp(),
        hint: userPass ? "manual" : "auto"  // Ä°pucu: manuel mi otomatik mi
      });

      const keyParam = urlSafeBase64(btoa(password));
      const shareUrl = window.location.href.split('?')[0] + "?id=" + pasteId + "&k=" + keyParam;

      document.getElementById('output').innerHTML = `
        <strong>âœ… Paste ultra gÃ¼venli ÅŸekilde oluÅŸturuldu!</strong><br><br>
        <strong>PaylaÅŸÄ±labilir Link:</strong><br>
        <input type="text" value="${shareUrl}" readonly style="width:100%; padding:10px; font-size:14px;"><br><br>
        <div class="info">
          â€¢ Åifre ${userPass ? '<strong>senin girdiÄŸin</strong>' : '<strong>otomatik gÃ¼Ã§lÃ¼ Ã¼retildi</strong>'}.<br>
          â€¢ Linkteki <code>k=</code> kÄ±smÄ± ÅŸifre anahtarÄ± (gÃ¼venli kodlanmÄ±ÅŸ).<br>
          â€¢ F12 console'da bile ÅŸifre aÃ§Ä±kta deÄŸil.<br>
          â€¢ Sunucuda veri tamamen ÅŸifreli â†’ kimse okuyamaz!<br>
          <span class="warning">â€¢ Linki paylaÅŸÄ±rken dikkatli ol!</span>
        </div>
      `;
    }

    async function loadPaste() {
      const params = new URLSearchParams(window.location.search);
      const pasteId = params.get('id');
      const keyParam = params.get('k');

      if (!pasteId || !keyParam) {
        document.getElementById('output').innerHTML = `<strong>âš ï¸ GeÃ§ersiz link!</strong>`;
        return;
      }

      let password;
      try {
        password = atob(keyParam.replace(/-/g, '+').replace(/_/g, '/'));
        while (password.length % 4) password += '=';
        password = atob(password);
      } catch (e) {
        document.getElementById('output').innerHTML = `<strong>âŒ Bozuk ÅŸifre anahtarÄ±!</strong>`;
        return;
      }

      const doc = await db.collection("pastes").doc(pasteId).get();
      if (!doc.exists) {
        document.getElementById('output').innerHTML = "Paste bulunamadÄ±! ğŸ˜¢";
        return;
      }

      const encrypted = doc.data().data;
      const hint = doc.data().hint;

      const decrypted = await decryptText(encrypted, password);

      if (!decrypted) {
        document.getElementById('output').innerHTML = "<strong>âŒ YanlÄ±ÅŸ ÅŸifre!</strong>";
        return;
      }

      const created = doc.data().created ? doc.data().created.toDate().toLocaleString('tr-TR') : "Bilinmiyor";

      document.getElementById('output').innerHTML = `
        <strong>ğŸ”“ Metin baÅŸarÄ±yla Ã§Ã¶zÃ¼ldÃ¼!</strong><br>
        OluÅŸturulma: ${created}<br><br>
        <pre>${decrypted}</pre>
      `;
    }

    window.onload = loadPaste;
  </script>
</body>
</html>
